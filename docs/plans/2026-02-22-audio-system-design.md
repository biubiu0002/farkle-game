# éŸ³æ•ˆç³»ç»Ÿå¢å¼ºè®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**: 2026-02-22
**ä½œè€…**: Claude Sonnet 4.5
**çŠ¶æ€**: å·²æ‰¹å‡†

## æ¦‚è¿°

ä¸º Farkle æ¸¸æˆæ·»åŠ èƒŒæ™¯éŸ³ä¹ï¼ˆBGMï¼‰åŠŸèƒ½ï¼Œå¹¶å¢å¼ºéŸ³æ•ˆç³»ç»Ÿçš„æ§åˆ¶èƒ½åŠ›ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å·¦ä¸Šè§’çš„å¯æŠ˜å é¢æ¿æ§åˆ¶ BGM å’ŒéŸ³æ•ˆçš„å¼€å…³åŠéŸ³é‡ã€‚

## éœ€æ±‚

### åŠŸèƒ½éœ€æ±‚
1. **BGM ç³»ç»Ÿ**
   - ä½¿ç”¨ `simple-game/å¢™æ´bgm_1.mp4` ä½œä¸ºèƒŒæ™¯éŸ³ä¹
   - è‡ªåŠ¨å¾ªç¯æ’­æ”¾
   - æ”¯æŒå¼€å…³æ§åˆ¶
   - æ”¯æŒéŸ³é‡è°ƒèŠ‚ï¼ˆ0-100%ï¼‰

2. **éŸ³æ•ˆç³»ç»Ÿ**
   - ä¿æŒç°æœ‰ Web Audio API éŸ³æ•ˆï¼ˆSoundManagerï¼‰
   - æ”¯æŒå…¨å±€å¼€å…³æ§åˆ¶
   - æ”¯æŒéŸ³é‡è°ƒèŠ‚ï¼ˆ0-100%ï¼‰

3. **ç”¨æˆ·ç•Œé¢**
   - å·¦ä¸Šè§’å›ºå®šä½ç½®
   - å¯æŠ˜å é¢æ¿ï¼ˆé»˜è®¤æŠ˜å ï¼‰
   - æ˜¾ç¤º BGM å’ŒéŸ³æ•ˆçš„å¼€å…³åŠéŸ³é‡æ»‘å—
   - è®¾ç½®æŒä¹…åŒ–åˆ° localStorage

### éåŠŸèƒ½éœ€æ±‚
- æµè§ˆå™¨å…¼å®¹æ€§ï¼šChromeã€Safariã€Firefoxã€ç§»åŠ¨ç«¯
- æ€§èƒ½ï¼šBGM æ–‡ä»¶çº¦ 3MBï¼Œéœ€å¿«é€ŸåŠ è½½
- ç”¨æˆ·ä½“éªŒï¼šé¦–æ¬¡äº¤äº’åæ‰å¼€å§‹æ’­æ”¾ï¼ˆé¿å…è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VolumeControlPanel              â”‚
â”‚  (UI ç»„ä»¶ - å¯æŠ˜å é¢æ¿)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚
      â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚BGMManagerâ”‚      â”‚SoundManager â”‚
â”‚(æ–°å¢)    â”‚      â”‚(å·²æœ‰ï¼Œæ‰©å±•)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚
      â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      localStorage            â”‚
â”‚  (æŒä¹…åŒ–éŸ³é‡è®¾ç½®)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶èŒè´£

1. **BGMManager**
   - ç®¡ç† HTML5 Audio å…ƒç´ 
   - æ§åˆ¶æ’­æ”¾ã€æš‚åœã€å¾ªç¯
   - ç®¡ç†éŸ³é‡å’Œå¼€å…³çŠ¶æ€
   - å“åº”æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶

2. **SoundManager**ï¼ˆæ‰©å±•ï¼‰
   - ä¿æŒç°æœ‰ Web Audio API å®ç°
   - æ·»åŠ å…¨å±€éŸ³é‡æ§åˆ¶æ–¹æ³•
   - æ”¯æŒæ€»å¼€å…³

3. **VolumeControlPanel**
   - æ¸²æŸ“ UI ç•Œé¢
   - å¤„ç†ç”¨æˆ·äº¤äº’
   - ä¸éŸ³é¢‘ç®¡ç†å™¨é€šä¿¡
   - æŒä¹…åŒ–è®¾ç½®

4. **LocalStorage**
   - å­˜å‚¨ç”¨æˆ·åå¥½è®¾ç½®
   - æ¸¸æˆå¯åŠ¨æ—¶æ¢å¤è®¾ç½®

## API è®¾è®¡

### BGMManager

```javascript
class BGMManager {
  constructor(audioPath)
  init(): Promise<boolean>
  play(): void
  pause(): void
  toggle(): void
  setVolume(volume: number): void  // 0-1
  setEnabled(enabled: boolean): void
  destroy(): void

  // åªè¯»å±æ€§
  get isPlaying(): boolean
  get volume(): number
  get enabled(): boolean
}
```

**å®ç°ç»†èŠ‚**ï¼š
- ä½¿ç”¨ `HTMLAudioElement`
- è®¾ç½® `loop` å±æ€§å®ç°å¾ªç¯
- `volume` å±æ€§æ§åˆ¶éŸ³é‡ï¼ˆ0-1ï¼‰
- ç›‘å¬ `error` äº‹ä»¶å¤„ç†åŠ è½½å¤±è´¥

### SoundManager æ‰©å±•

ä¿æŒç°æœ‰ APIï¼Œæ·»åŠ ï¼š

```javascript
// æ–°å¢æ–¹æ³•
setGlobalVolume(volume: number): void  // 0-1
getVolume(): number

// æ–°å¢å±æ€§
enabled: boolean  // å·²æœ‰ï¼Œæ–‡æ¡£åŒ–
volume: number    // å·²æœ‰ï¼Œæ–‡æ¡£åŒ–
```

### VolumeControlPanel

```javascript
class VolumeControlPanel {
  constructor(bgmManager, sfxManager)

  init(): void
  render(): void
  togglePanel(): void
  updateBGMState(enabled, volume): void
  updateSFXState(enabled, volume): void
  saveSettings(): void
  loadSettings(): void

  // UI çŠ¶æ€
  collapsed: boolean
  bgmEnabled: boolean
  bgmVolume: number
  sfxEnabled: boolean
  sfxVolume: number
}
```

## UI è®¾è®¡

### å¸ƒå±€

**ä½ç½®**ï¼šå›ºå®šåœ¨å·¦ä¸Šè§’
```css
position: fixed;
top: 10px;
left: 10px;
z-index: 1000;
```

**æŠ˜å çŠ¶æ€**ï¼š
- æ˜¾ç¤ºå°å›¾æ ‡æŒ‰é’®ï¼ˆğŸ”Š æˆ– ğŸ”‡ï¼‰
- å°ºå¯¸ï¼š40x40px
- ç‚¹å‡»å±•å¼€é¢æ¿

**å±•å¼€çŠ¶æ€**ï¼š
- å®½åº¦ï¼š280px
- åŠé€æ˜èƒŒæ™¯ï¼š`rgba(255, 255, 255, 0.95)`
- åœ†è§’ï¼š12px
- é˜´å½±ï¼š`0 4px 12px rgba(0, 0, 0, 0.15)`

### ç»„ä»¶ç»“æ„

```html
<div id="volumeControlPanel" class="volume-panel collapsed">
  <!-- æŠ˜å æŒ‰é’® -->
  <button id="togglePanelBtn" class="panel-toggle">ğŸ”Š</button>

  <!-- å±•å¼€å†…å®¹ -->
  <div class="panel-content">
    <h3>å£°éŸ³è®¾ç½®</h3>

    <!-- BGM æ§åˆ¶ -->
    <div class="control-group">
      <div class="control-header">
        <label>èƒŒæ™¯éŸ³ä¹</label>
        <input type="checkbox" id="bgmEnabled">
      </div>
      <input type="range" id="bgmVolume" min="0" max="100" value="30">
    </div>

    <!-- éŸ³æ•ˆæ§åˆ¶ -->
    <div class="control-group">
      <div class="control-header">
        <label>æ¸¸æˆéŸ³æ•ˆ</label>
        <input type="checkbox" id="sfxEnabled">
      </div>
      <input type="range" id="sfxVolume" min="0" max="100" value="20">
    </div>
  </div>
</div>
```

### äº¤äº’è¡Œä¸º

1. **ç‚¹å‡»æŠ˜å æŒ‰é’®** â†’ å±•å¼€/æ”¶èµ·é¢æ¿
2. **æ‹–åŠ¨éŸ³é‡æ»‘å—** â†’ å®æ—¶æ›´æ–°éŸ³é‡
3. **åˆ‡æ¢å¼€å…³** â†’ ç«‹å³å¯ç”¨/ç¦ç”¨
4. **ä¿®æ”¹ä»»ä½•è®¾ç½®** â†’ è‡ªåŠ¨ä¿å­˜åˆ° localStorage

## æ•°æ®æŒä¹…åŒ–

### LocalStorage ç»“æ„

**é”®å**: `farkle_audio_settings`

**æ•°æ®æ ¼å¼**:
```json
{
  "bgm": {
    "enabled": true,
    "volume": 0.3
  },
  "sfx": {
    "enabled": true,
    "volume": 0.2
  },
  "panelCollapsed": true
}
```

### é»˜è®¤å€¼

```javascript
const DEFAULT_SETTINGS = {
  bgm: {
    enabled: true,
    volume: 0.3  // 30% éŸ³é‡
  },
  sfx: {
    enabled: true,
    volume: 0.2  // 20% éŸ³é‡ï¼ˆä¸å½“å‰ä¸€è‡´ï¼‰
  },
  panelCollapsed: true
}
```

### ä¿å­˜æ—¶æœº

1. ç”¨æˆ·ä¿®æ”¹ä»»ä½•è®¾ç½®æ—¶ç«‹å³ä¿å­˜
2. é˜²æŠ–å¤„ç†ï¼ˆ500msï¼‰é¿å…é¢‘ç¹å†™å…¥

### åŠ è½½æ—¶æœº

1. æ¸¸æˆå¯åŠ¨æ—¶ï¼ˆ`initSoundManager` ä¹‹åï¼‰
2. é¢æ¿åˆå§‹åŒ–æ—¶

## å®ç°æ–¹æ¡ˆ

### æŠ€æœ¯é€‰å‹ï¼šæ–¹æ¡ˆ A - HTML Audio + Web Audio API

**é€‰æ‹©ç†ç”±**ï¼š
1. BGM ä½¿ç”¨ `<audio>` å…ƒç´ ï¼Œç®€å•å¯é 
2. éŸ³æ•ˆç»§ç»­ä½¿ç”¨ Web Audio API
3. ä¸¤ä¸ªç‹¬ç«‹éŸ³é‡æ§åˆ¶ï¼Œäº’ä¸å¹²æ‰°
4. ä¸éœ€è¦é¢å¤–ä¾èµ–åº“
5. BGM å¾ªç¯æ’­æ”¾ç¨³å®šï¼Œå†…å­˜å ç”¨å°

**ä¼˜åŠ¿**ï¼š
- å®ç°ç®€å•ï¼Œä»£ç é‡å°‘
- æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œå…¼å®¹æ€§å¥½
- æ€§èƒ½ä¼˜å¼‚ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- æ˜“äºç»´æŠ¤å’Œè°ƒè¯•

### æ–‡ä»¶ç»“æ„

```
simple-game/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ sound-manager.js       # å·²æœ‰ï¼Œæ‰©å±•éŸ³é‡æ§åˆ¶
â”‚   â”œâ”€â”€ bgm-manager.js         # æ–°å¢ BGM ç®¡ç†å™¨
â”‚   â””â”€â”€ volume-panel.js        # æ–°å¢éŸ³é‡æ§åˆ¶é¢æ¿
â”œâ”€â”€ game.js                    # ä¿®æ”¹ï¼šé›†æˆ BGM
â”œâ”€â”€ index.html                 # ä¿®æ”¹ï¼šæ·»åŠ é¢æ¿ DOM
â”œâ”€â”€ style.css                  # ä¿®æ”¹ï¼šæ·»åŠ é¢æ¿æ ·å¼
â””â”€â”€ å¢™æ´bgm_1.mp4              # å·²æœ‰ BGM æ–‡ä»¶
```

## é”™è¯¯å¤„ç†

### BGM åŠ è½½å¤±è´¥

**é—®é¢˜**ï¼šéŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ã€æ–‡ä»¶æŸåç­‰ï¼‰

**å¤„ç†æ–¹æ¡ˆ**ï¼š
```javascript
audioElement.addEventListener('error', (e) => {
  console.error('BGM åŠ è½½å¤±è´¥:', e);
  bgmManager.setEnabled(false);
  // ä¸é˜»å¡æ¸¸æˆï¼Œä»…ç¦ç”¨ BGM
  showNotification('èƒŒæ™¯éŸ³ä¹åŠ è½½å¤±è´¥');
});
```

### æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶

**é—®é¢˜**ï¼šæµè§ˆå™¨é˜»æ­¢æœªäº¤äº’é¡µé¢çš„è‡ªåŠ¨æ’­æ”¾

**å¤„ç†æ–¹æ¡ˆ**ï¼š
```javascript
// æ–¹æ¡ˆ 1ï¼šé¦–æ¬¡ç”¨æˆ·äº¤äº’åæ’­æ”¾
document.addEventListener('click', () => {
  if (bgmManager.enabled && !bgmManager.isPlaying) {
    bgmManager.play();
  }
}, { once: true });

// æ–¹æ¡ˆ 2ï¼šé™éŸ³è‡ªåŠ¨æ’­æ”¾ï¼Œç„¶åå–æ¶ˆé™éŸ³
audioElement.muted = true;
audioElement.play().then(() => {
  audioElement.muted = false;
});
```

### å†…å­˜æ³„æ¼

**é—®é¢˜**ï¼šéŸ³é¢‘å…ƒç´ æœªæ­£ç¡®é‡Šæ”¾

**å¤„ç†æ–¹æ¡ˆ**ï¼š
```javascript
// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', () => {
  bgmManager.destroy();
  window.SoundManager.destroy();
});
```

## æµ‹è¯•è®¡åˆ’

### åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | æ“ä½œ | é¢„æœŸç»“æœ |
|--------|------|----------|
| BGM è‡ªåŠ¨æ’­æ”¾ | å¯åŠ¨æ¸¸æˆ | BGM å¼€å§‹å¾ªç¯æ’­æ”¾ |
| BGM éŸ³é‡è°ƒèŠ‚ | æ‹–åŠ¨æ»‘å— | éŸ³é‡å®æ—¶å˜åŒ– |
| BGM å¼€å…³ | åˆ‡æ¢å¤é€‰æ¡† | BGM æ’­æ”¾/æš‚åœ |
| éŸ³æ•ˆéŸ³é‡è°ƒèŠ‚ | æ‹–åŠ¨æ»‘å— | éŸ³æ•ˆéŸ³é‡å˜åŒ– |
| éŸ³æ•ˆå¼€å…³ | åˆ‡æ¢å¤é€‰æ¡† | éŸ³æ•ˆå¯ç”¨/ç¦ç”¨ |
| é¢æ¿æŠ˜å  | ç‚¹å‡»å›¾æ ‡ | é¢æ¿å±•å¼€/æ”¶èµ· |
| è®¾ç½®æŒä¹…åŒ– | åˆ·æ–°é¡µé¢ | è®¾ç½®ä¿æŒä¸å˜ |

### å…¼å®¹æ€§æµ‹è¯•

- Chrome 90+ (æ¡Œé¢/ç§»åŠ¨)
- Safari 14+ (iOS/macOS)
- Firefox 88+
- Edge 90+

### æ€§èƒ½æµ‹è¯•

- BGM æ–‡ä»¶åŠ è½½æ—¶é—´ < 3sï¼ˆæ­£å¸¸ç½‘ç»œï¼‰
- å†…å­˜å ç”¨ < 50MBï¼ˆåŒ…å«éŸ³é¢‘ï¼‰
- é¢æ¿åŠ¨ç”» 60fps

## å®æ–½æ­¥éª¤ï¼ˆæ¦‚è¦ï¼‰

1. **åˆ›å»º BGMManager** (`utils/bgm-manager.js`)
   - å®ç°éŸ³é¢‘å…ƒç´ ç®¡ç†
   - å®ç°æ’­æ”¾/æš‚åœ/éŸ³é‡æ§åˆ¶
   - æ·»åŠ é”™è¯¯å¤„ç†

2. **æ‰©å±• SoundManager** (`utils/sound-manager.js`)
   - æ·»åŠ  `setGlobalVolume` æ–¹æ³•
   - æ–‡æ¡£åŒ–ç°æœ‰ API

3. **åˆ›å»º VolumeControlPanel** (`utils/volume-panel.js`)
   - å®ç° UI æ¸²æŸ“
   - å®ç°äº‹ä»¶å¤„ç†
   - å®ç° localStorage æŒä¹…åŒ–

4. **é›†æˆåˆ°æ¸¸æˆ** (`game.js`, `index.html`)
   - åˆå§‹åŒ– BGM Manager
   - æ·»åŠ éŸ³é‡é¢æ¿ DOM
   - è¿æ¥å„ç»„ä»¶

5. **æ·»åŠ æ ·å¼** (`style.css`)
   - é¢æ¿åŸºç¡€æ ·å¼
   - æŠ˜å /å±•å¼€åŠ¨ç”»
   - å“åº”å¼é€‚é…

6. **æµ‹è¯•éªŒè¯**
   - åŠŸèƒ½æµ‹è¯•
   - å…¼å®¹æ€§æµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

## åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **å¤šé¦– BGM è½®æ’­** - æ”¯æŒæ’­æ”¾åˆ—è¡¨
2. **å¯è§†åŒ–éŸ³æ•ˆ** - æ’­æ”¾æ—¶æ˜¾ç¤ºæ³¢å½¢åŠ¨ç”»
3. **é¢„è®¾éŸ³é‡æ–¹æ¡ˆ** - æä¾›"é™éŸ³"ã€"ç™½å¤©"ã€"å¤œé—´"ç­‰é¢„è®¾
4. **éŸ³é¢‘å‹ç¼©** - é™ä½ BGM æ–‡ä»¶å¤§å°
5. **éŸ³æ•ˆå¢å¼º** - æ·»åŠ æ›´å¤šæ¸¸æˆéŸ³æ•ˆ

## é£é™©ä¸é™åˆ¶

1. **BGM æ–‡ä»¶å¤§å°**ï¼š3MB å¯èƒ½åœ¨æ…¢é€Ÿç½‘ç»œåŠ è½½æ…¢
   - ç¼“è§£ï¼šæ·»åŠ åŠ è½½æç¤ºï¼Œé¢„åŠ è½½æœºåˆ¶

2. **ç§»åŠ¨ç«¯æµé‡**ï¼šè‡ªåŠ¨æ’­æ”¾å¯èƒ½æ¶ˆè€—ç”¨æˆ·æµé‡
   - ç¼“è§£ï¼šé»˜è®¤ 30% éŸ³é‡ï¼Œæä¾›æ˜ç¡®å¼€å…³

3. **æµè§ˆå™¨å…¼å®¹æ€§**ï¼šæ—§ç‰ˆæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ
   - ç¼“è§£ï¼šæ·»åŠ  feature detectionï¼Œä¼˜é›…é™çº§

## æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆåœ¨ä¿æŒç°æœ‰éŸ³æ•ˆç³»ç»Ÿç¨³å®šçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ·»åŠ  BGMManager å’Œ VolumeControlPanel ä¸¤ä¸ªæ–°ç»„ä»¶ï¼Œå®ç°äº†å®Œæ•´çš„èƒŒæ™¯éŸ³ä¹å’ŒéŸ³æ•ˆæ§åˆ¶åŠŸèƒ½ã€‚æ–¹æ¡ˆé‡‡ç”¨æˆç†Ÿå¯é çš„ HTML5 Audio å’Œ Web Audio API æŠ€æœ¯ï¼Œå®ç°ç®€å•ã€æ€§èƒ½ä¼˜å¼‚ã€ç”¨æˆ·ä½“éªŒè‰¯å¥½ã€‚

é¢„è®¡å¼€å‘æ—¶é—´ï¼š2-3 å°æ—¶
é¢„è®¡æµ‹è¯•æ—¶é—´ï¼š1 å°æ—¶
æ€»è®¡ï¼š3-4 å°æ—¶
